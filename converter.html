<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEDCOM Converter ‚Äî Lineage Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#1a1a2e;--bg2:#16213e;--parchment:#f5f0e8;--brown:#3e2723;--gold:#c5960c;--green:#2e7d32;--text:#e0e0e0;--text-muted:#999;--border:#2a2a4a;--card:#1e1e3a;--danger:#c62828}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
h1,h2,h3,h4{font-family:'Playfair Display',serif;color:var(--parchment)}
a{color:var(--gold);text-decoration:none}a:hover{text-decoration:underline}

/* Nav */
nav{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 2rem;display:flex;align-items:center;height:56px;gap:2rem;position:sticky;top:0;z-index:100}
nav .logo{font-family:'Playfair Display',serif;color:var(--gold);font-size:1.25rem;font-weight:700;white-space:nowrap}
nav .links{display:flex;gap:1.5rem}
nav .links a{color:var(--text-muted);font-size:.875rem;font-weight:500;transition:color .2s}
nav .links a:hover,nav .links a.active{color:var(--gold);text-decoration:none}

/* Layout */
.container{max-width:1100px;margin:0 auto;padding:2rem 1.5rem}
.hero{text-align:center;margin-bottom:2.5rem}
.hero h1{font-size:2rem;margin-bottom:.5rem}
.hero p{color:var(--text-muted);max-width:600px;margin:0 auto}

/* Drop zone */
.dropzone{border:2px dashed var(--gold);border-radius:12px;padding:3rem 2rem;text-align:center;cursor:pointer;transition:all .3s;background:rgba(197,150,12,.04);margin-bottom:2rem}
.dropzone:hover,.dropzone.dragover{background:rgba(197,150,12,.1);border-color:#e0ad0e}
.dropzone h3{margin-bottom:.5rem;font-size:1.25rem}
.dropzone p{color:var(--text-muted);font-size:.875rem}
.dropzone input{display:none}
.dropzone .icon{font-size:2.5rem;margin-bottom:.75rem}

/* Progress */
.progress-wrap{display:none;margin-bottom:2rem}
.progress-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.progress-bar .fill{height:100%;background:var(--gold);width:0;transition:width .3s}
.progress-label{font-size:.8rem;color:var(--text-muted);margin-top:.4rem;text-align:center}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin-bottom:2rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1.25rem;text-align:center}
.stat-card .num{font-size:2rem;font-weight:700;color:var(--gold);font-family:'Playfair Display',serif}
.stat-card .label{font-size:.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-top:.25rem}

/* Warnings */
.warnings{background:rgba(198,40,40,.1);border:1px solid var(--danger);border-radius:8px;padding:1rem 1.25rem;margin-bottom:1.5rem;display:none;max-height:200px;overflow-y:auto}
.warnings h4{color:var(--danger);margin-bottom:.5rem;font-size:.95rem}
.warnings ul{padding-left:1.25rem;font-size:.8rem;color:#e57373}

/* Tabs */
.tabs{display:flex;gap:0;margin-bottom:0;border-bottom:1px solid var(--border)}
.tab-btn{background:none;border:none;color:var(--text-muted);padding:.75rem 1.25rem;cursor:pointer;font-family:'Inter',sans-serif;font-size:.875rem;font-weight:500;border-bottom:2px solid transparent;transition:all .2s}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{color:var(--gold);border-bottom-color:var(--gold)}
.tab-panel{display:none;background:var(--card);border:1px solid var(--border);border-top:none;border-radius:0 0 10px 10px;padding:1.25rem;margin-bottom:2rem;overflow-x:auto}
.tab-panel.active{display:block}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{text-align:left;color:var(--gold);font-weight:600;padding:.6rem .75rem;border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:.5rem .75rem;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:top}
tr:hover td{background:rgba(255,255,255,.02)}
.sex-badge{display:inline-block;padding:1px 8px;border-radius:4px;font-size:.75rem;font-weight:600}
.sex-M{background:rgba(66,165,245,.15);color:#42a5f5}
.sex-F{background:rgba(239,83,80,.15);color:#ef5350}
.sex-U{background:rgba(158,158,158,.15);color:#9e9e9e}
.type-badge{display:inline-block;padding:1px 8px;border-radius:4px;font-size:.75rem;background:rgba(197,150,12,.12);color:var(--gold)}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1.5rem;border:none;border-radius:8px;font-family:'Inter',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s}
.btn-gold{background:var(--gold);color:#1a1a2e}.btn-gold:hover{background:#d4a30e}
.btn-outline{background:none;border:1px solid var(--border);color:var(--text)}.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#b71c1c}
.actions{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;margin:2rem 0}

/* Results area */
#results{display:none}

/* JSON preview */
.json-preview{background:#0d0d1a;border:1px solid var(--border);border-radius:8px;padding:1rem;max-height:400px;overflow:auto;font-family:'Courier New',monospace;font-size:.8rem;color:#8bc34a;white-space:pre;display:none;margin-top:1rem}

/* Responsive */
@media(max-width:640px){
  nav{padding:0 1rem;gap:1rem}
  .container{padding:1.5rem 1rem}
  .hero h1{font-size:1.5rem}
  .dropzone{padding:2rem 1rem}
  .stats{grid-template-columns:repeat(2,1fr)}
  .tab-btn{padding:.6rem .75rem;font-size:.8rem}
}
</style>
</head>
<body>

<nav>
  <div class="logo">Lineage Hub</div>
  <div class="links">
    <a href="index.html">Home</a>
    <a href="converter.html" class="active">GEDCOM Converter</a>
    <a href="research.html">Research</a>
    <a href="tree.html">Family Tree</a>
  </div>
</nav>

<div class="container">
  <div class="hero">
    <h1>GEDCOM ‚Üí Lineage JSON</h1>
    <p>Upload a GEDCOM file and convert it to Lineage schema JSON. Everything runs in your browser ‚Äî no data leaves your device.</p>
  </div>

  <div class="dropzone" id="dropzone">
    <div class="icon">üìú</div>
    <h3>Drop your .ged file here</h3>
    <p>or click to browse</p>
    <input type="file" id="fileInput" accept=".ged,.gedcom">
  </div>

  <div class="progress-wrap" id="progressWrap">
    <div class="progress-bar"><div class="fill" id="progressFill"></div></div>
    <div class="progress-label" id="progressLabel">Parsing‚Ä¶</div>
  </div>

  <div id="results">
    <div class="stats" id="statsGrid"></div>
    <div class="warnings" id="warnings"><h4>‚ö† Parsing Warnings</h4><ul id="warningList"></ul></div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="individuals">Individuals</button>
      <button class="tab-btn" data-tab="events">Events</button>
      <button class="tab-btn" data-tab="sources">Sources</button>
      <button class="tab-btn" data-tab="json">JSON Preview</button>
    </div>
    <div class="tab-panel active" id="panel-individuals"></div>
    <div class="tab-panel" id="panel-events"></div>
    <div class="tab-panel" id="panel-sources"></div>
    <div class="tab-panel" id="panel-json"><div class="json-preview" id="jsonPreview" style="display:block"></div></div>

    <div class="actions">
      <button class="btn btn-gold" id="downloadBtn">‚¨á Download Lineage JSON</button>
      <button class="btn btn-outline" id="pushBtn">‚òÅ Push to Supabase</button>
      <button class="btn btn-outline" id="copyBtn">üìã Copy to Clipboard</button>
      <button class="btn btn-danger" id="resetBtn">‚úï Reset</button>
    </div>

    <div id="pushProgress" style="display:none;margin:1rem 0">
      <div class="progress-bar"><div class="fill" id="pushFill"></div></div>
      <div class="progress-label" id="pushLabel">Preparing‚Ä¶</div>
      <div id="pushLog" style="max-height:200px;overflow-y:auto;font-size:.8rem;color:var(--text-muted);margin-top:.5rem;font-family:monospace"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script>
(function(){
'use strict';
const statusEl = createConnectionIndicator();
// Test Supabase connection on load
(async()=>{
  try {
    const db = initSupabase();
    if (!db) throw new Error('no client');
    const { count } = await db.from('individuals').select('id', { count:'exact', head:true });
    setConnectionStatus(statusEl, 'connected');
  } catch(e) {
    setConnectionStatus(statusEl, 'fallback');
  }
})();

/* ‚îÄ‚îÄ Utility ‚îÄ‚îÄ */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const MONTHS = {JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'};
let idCounters = {ind:0,evt:0,src:0};
function makeId(prefix){idCounters[prefix]++;return prefix+'_'+String(idCounters[prefix]).padStart(12,'0')}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}

/* ‚îÄ‚îÄ GEDCOM Parser ‚îÄ‚îÄ */
function parseGedcom(text){
  const warnings=[];
  const lines=text.replace(/\r\n?/g,'\n').split('\n');
  // Build tree
  const root={level:-1,tag:'ROOT',value:'',children:[]};
  const stack=[root];
  for(let i=0;i<lines.length;i++){
    const line=lines[i];
    if(!line.trim())continue;
    const m=line.match(/^(\d+)\s+(@[^@]+@\s+)?(\S+)\s?(.*)?$/);
    if(!m){warnings.push(`Line ${i+1}: Could not parse "${line.substring(0,60)}"`);continue}
    const level=parseInt(m[1],10);
    const xref=m[2]?m[2].trim():null;
    const tag=m[3].toUpperCase();
    const value=(m[4]||'').trim();
    const node={level,xref,tag,value,children:[],lineNum:i+1};
    // Handle CONC/CONT
    if(tag==='CONT'){
      const parent=stack[stack.length-1];
      if(parent&&parent.level>=0)parent.value+='\n'+value;
      continue;
    }
    if(tag==='CONC'){
      const parent=stack[stack.length-1];
      if(parent&&parent.level>=0)parent.value+=value;
      continue;
    }
    while(stack.length>1&&stack[stack.length-1].level>=level)stack.pop();
    stack[stack.length-1].children.push(node);
    stack.push(node);
  }
  return {root,warnings};
}

function findChild(node,tag){return node.children.find(c=>c.tag===tag)}
function findChildren(node,tag){return node.children.filter(c=>c.tag===tag)}
function childVal(node,tag){const c=findChild(node,tag);return c?c.value:''}

/* ‚îÄ‚îÄ Date normalization ‚îÄ‚îÄ */
function normalizeDate(raw){
  if(!raw)return{original:'',normalized:'',precision:'estimated',qualifier:null};
  const orig=raw;
  let qualifier=null,s=raw.toUpperCase().trim();
  if(s.startsWith('ABT')||s.startsWith('ABT.')||s.startsWith('ABOUT')){qualifier='about';s=s.replace(/^ABT\.?\s*|^ABOUT\s*/i,'');}
  else if(s.startsWith('BEF')||s.startsWith('BEFORE')){qualifier='before';s=s.replace(/^BEF\.?\s*|^BEFORE\s*/i,'');}
  else if(s.startsWith('AFT')||s.startsWith('AFTER')){qualifier='after';s=s.replace(/^AFT\.?\s*|^AFTER\s*/i,'');}
  else if(s.startsWith('EST')){qualifier='about';s=s.replace(/^EST\.?\s*/i,'');}
  else if(s.startsWith('BET')){
    qualifier='between';
    const bm=s.match(/^BET\.?\s*(.+?)\s+AND\s+(.+)$/i);
    if(bm){
      const d1=parseSingleDate(bm[1]);
      const d2=parseSingleDate(bm[2]);
      return{original:orig,normalized:d1.normalized,normalized_end:d2.normalized,precision:d1.precision,qualifier};
    }
    s=s.replace(/^BET\.?\s*/i,'');
  }
  const d=parseSingleDate(s);
  return{original:orig,normalized:d.normalized,precision:d.precision,qualifier};
}

function parseSingleDate(s){
  s=s.trim();
  // DD MON YYYY
  let m=s.match(/^(\d{1,2})\s+([A-Z]{3})\s+(\d{4})$/);
  if(m&&MONTHS[m[2]])return{normalized:`${m[3]}-${MONTHS[m[2]]}-${m[1].padStart(2,'0')}`,precision:'exact'};
  // MON YYYY
  m=s.match(/^([A-Z]{3})\s+(\d{4})$/);
  if(m&&MONTHS[m[1]])return{normalized:`${m[2]}-${MONTHS[m[1]]}`,precision:'month'};
  // YYYY
  m=s.match(/^(\d{4})$/);
  if(m)return{normalized:m[1],precision:'year'};
  // decade
  m=s.match(/^(\d{3})0s?$/);
  if(m)return{normalized:m[1]+'0',precision:'decade'};
  return{normalized:s,precision:'estimated'};
}

/* ‚îÄ‚îÄ Name parsing ‚îÄ‚îÄ */
function parseName(raw){
  const result={given:'',middle:'',surname:'',suffix:'',maiden:'',aliases:[]};
  if(!raw)return result;
  const sm=raw.match(/\/([^/]*)\//);
  if(sm)result.surname=sm[1].trim();
  const outside=raw.replace(/\/[^/]*\//,'|').split('|');
  const givenParts=(outside[0]||'').trim().split(/\s+/);
  if(givenParts.length>0)result.given=givenParts[0];
  if(givenParts.length>1)result.middle=givenParts.slice(1).join(' ');
  const after=(outside[1]||'').trim();
  if(after)result.suffix=after;
  return result;
}

/* ‚îÄ‚îÄ Event type mapping ‚îÄ‚îÄ */
const EVENT_MAP={BIRT:'birth',DEAT:'death',MARR:'marriage',BURI:'burial',RESI:'residence',OCCU:'occupation',CENS:'census',MILI:'military_service',IMMI:'immigration',NATU:'naturalization',BAPM:'baptism',CHR:'baptism',BAPL:'baptism',GRAD:'education',RETI:'retirement',EMIG:'immigration',PROB:'other',WILL:'other'};

/* ‚îÄ‚îÄ Place parsing (best-effort) ‚îÄ‚îÄ */
function parsePlace(raw){
  const r={original:raw||'',country:'',state:'',county:'',city:'',address:''};
  if(!raw)return r;
  const parts=raw.split(',').map(s=>s.trim()).filter(Boolean);
  if(parts.length>=4){r.city=parts[0];r.county=parts[1];r.state=parts[2];r.country=parts[3]}
  else if(parts.length===3){r.city=parts[0];r.state=parts[1];r.country=parts[2]}
  else if(parts.length===2){r.city=parts[0];r.state=parts[1]}
  else if(parts.length===1){r.city=parts[0]}
  return r;
}

/* ‚îÄ‚îÄ Source type guess ‚îÄ‚îÄ */
function guessSourceType(title){
  if(!title)return'other';
  const t=title.toLowerCase();
  if(/census/.test(t))return'census';
  if(/birth|death|marriage|vital|certificate/.test(t))return'vital';
  if(/military|draft|pension|service/.test(t))return'military';
  if(/church|parish|baptis|christen/.test(t))return'church';
  if(/newspaper/.test(t))return'newspaper';
  if(/book|history/.test(t))return'book';
  return'other';
}

/* ‚îÄ‚îÄ Main conversion ‚îÄ‚îÄ */
function convert(text, progressCb){
  idCounters={ind:0,evt:0,src:0};
  progressCb(10,'Parsing GEDCOM structure‚Ä¶');
  const {root,warnings}=parseGedcom(text);
  progressCb(30,'Extracting records‚Ä¶');

  const gedIndis=root.children.filter(n=>n.tag==='INDI');
  const gedFams=root.children.filter(n=>n.tag==='FAM');
  const gedSours=root.children.filter(n=>n.tag==='SOUR');

  // Source map: GEDCOM xref ‚Üí Lineage source
  const sourceMap={};
  const sources=[];
  for(const sn of gedSours){
    const sid=makeId('src');
    const title=childVal(sn,'TITL')||childVal(sn,'ABBR')||'';
    const repo=findChild(sn,'REPO');
    const repoName=repo?childVal(repo,'NAME'):'';
    const repoRef=repo?repo.value:'';
    const src={source_id:sid,type:guessSourceType(title),title,citation:childVal(sn,'TEXT')||childVal(sn,'AUTH')||'',repository:repoName,repository_ref:repoRef,processing_status:'imported'};
    sources.push(src);
    if(sn.xref)sourceMap[sn.xref]=sid;
  }
  progressCb(45,'Processing individuals‚Ä¶');

  // Individual map: GEDCOM xref ‚Üí lineage id
  const indiMap={};
  const individuals=[];
  const events=[];

  for(const ind of gedIndis){
    const iid=makeId('ind');
    if(ind.xref)indiMap[ind.xref]=iid;
    const nameNode=findChild(ind,'NAME');
    const name=parseName(nameNode?nameNode.value:'');
    // Check for maiden name (NICK or _MARNM or alternate NAME)
    if(nameNode){
      const nick=childVal(nameNode,'NICK');
      if(nick)name.aliases.push(nick);
      const marnm=childVal(nameNode,'_MARNM');
      if(marnm)name.maiden=name.surname;// if married name exists, current surname might be married
    }
    const altNames=findChildren(ind,'NAME').slice(1);
    for(const an of altNames){const p=parseName(an.value);if(p.given||p.surname)name.aliases.push(((p.given||'')+' '+(p.surname||'')).trim())}
    const suffix=childVal(ind,'TITL');
    if(suffix&&!name.suffix)name.suffix=suffix;
    const sex=childVal(ind,'SEX')||'U';
    const sexNorm=sex==='M'?'M':sex==='F'?'F':'U';

    const person={individual_id:iid,name,sex:sexNorm,living:false,relationships:[],research_status:'active'};

    // Events
    const eventTags=['BIRT','DEAT','BURI','RESI','OCCU','CENS','BAPM','CHR','IMMI','EMIG','NATU','MILI','GRAD','RETI'];
    for(const et of eventTags){
      const enodes=findChildren(ind,et);
      for(const en of enodes){
        const eid=makeId('evt');
        const dateRaw=childVal(en,'DATE');
        const placeRaw=childVal(en,'PLAC');
        const srcNodes=findChildren(en,'SOUR');
        const srcIds=srcNodes.map(s=>{
          const ref=s.value;
          if(sourceMap[ref])return sourceMap[ref];
          // Inline source
          const sid=makeId('src');
          const title=childVal(s,'TITL')||ref||'';
          sources.push({source_id:sid,type:guessSourceType(title),title,citation:childVal(s,'DATA')||childVal(s,'TEXT')||'',repository:'',repository_ref:'',processing_status:'imported'});
          if(ref)sourceMap[ref]=sid;
          return sid;
        });
        const ev={event_id:eid,type:EVENT_MAP[et]||'other',date:normalizeDate(dateRaw),place:parsePlace(placeRaw),participants:[{individual_id:iid,role:'principal'}],source_ids:srcIds};
        events.push(ev);
        if(et==='DEAT')person.living=false;
      }
    }
    // If no DEAT record, might be living ‚Äî heuristic: birth > 1920 and no death
    if(!findChild(ind,'DEAT')){
      const bn=findChild(ind,'BIRT');
      if(bn){const dy=childVal(bn,'DATE');const ym=dy&&dy.match(/(\d{4})/);if(ym&&parseInt(ym[1])>1920)person.living=true}
    }
    individuals.push(person);
  }

  progressCb(65,'Processing families‚Ä¶');

  // Families ‚Üí relationships + marriage events
  for(const fam of gedFams){
    const husbRef=childVal(fam,'HUSB');
    const wifeRef=childVal(fam,'WIFE');
    const childRefs=findChildren(fam,'CHIL').map(c=>c.value);
    const husbId=indiMap[husbRef]||null;
    const wifeId=indiMap[wifeRef]||null;

    // Spouse relationships
    if(husbId&&wifeId){
      const h=individuals.find(i=>i.individual_id===husbId);
      const w=individuals.find(i=>i.individual_id===wifeId);
      if(h)h.relationships.push({type:'spouse',individual_id:wifeId});
      if(w)w.relationships.push({type:'spouse',individual_id:husbId});
    }

    // Parent-child
    for(const cr of childRefs){
      const cid=indiMap[cr];
      if(!cid)continue;
      const child=individuals.find(i=>i.individual_id===cid);
      if(husbId){
        if(child)child.relationships.push({type:'parent',individual_id:husbId});
        const h=individuals.find(i=>i.individual_id===husbId);
        if(h)h.relationships.push({type:'child',individual_id:cid});
      }
      if(wifeId){
        if(child)child.relationships.push({type:'parent',individual_id:wifeId});
        const w=individuals.find(i=>i.individual_id===wifeId);
        if(w)w.relationships.push({type:'child',individual_id:cid});
      }
    }

    // Marriage events
    const marrNodes=findChildren(fam,'MARR');
    for(const mn of marrNodes){
      const eid=makeId('evt');
      const participants=[];
      if(husbId)participants.push({individual_id:husbId,role:'principal'});
      if(wifeId)participants.push({individual_id:wifeId,role:'spouse'});
      const srcNodes=findChildren(mn,'SOUR');
      const srcIds=srcNodes.map(s=>sourceMap[s.value]||s.value);
      events.push({event_id:eid,type:'marriage',date:normalizeDate(childVal(mn,'DATE')),place:parsePlace(childVal(mn,'PLAC')),participants,source_ids:srcIds.filter(Boolean)});
    }

    // Divorce as event
    const divNodes=findChildren(fam,'DIV');
    for(const dn of divNodes){
      const eid=makeId('evt');
      const participants=[];
      if(husbId)participants.push({individual_id:husbId,role:'principal'});
      if(wifeId)participants.push({individual_id:wifeId,role:'spouse'});
      events.push({event_id:eid,type:'other',date:normalizeDate(childVal(dn,'DATE')),place:parsePlace(childVal(dn,'PLAC')),participants,source_ids:[]});
    }
  }

  progressCb(85,'Finalizing‚Ä¶');

  // Deduplicate relationships
  for(const ind of individuals){
    const seen=new Set();
    ind.relationships=ind.relationships.filter(r=>{const k=r.type+'|'+r.individual_id;if(seen.has(k))return false;seen.add(k);return true});
  }

  progressCb(100,'Done!');
  return{individuals,events,sources,warnings};
}

/* ‚îÄ‚îÄ UI ‚îÄ‚îÄ */
let currentData=null;

// Drop zone
const dz=$('#dropzone'),fi=$('#fileInput');
dz.addEventListener('click',()=>fi.click());
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover')});
dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragover');if(e.dataTransfer.files.length)handleFile(e.dataTransfer.files[0])});
fi.addEventListener('change',()=>{if(fi.files.length)handleFile(fi.files[0])});

function handleFile(file){
  if(!file.name.match(/\.(ged|gedcom)$/i)){alert('Please select a .ged file');return}
  const reader=new FileReader();
  reader.onload=()=>{
    $('#progressWrap').style.display='block';
    // Use setTimeout to let the UI update
    setTimeout(()=>{
      try{
        currentData=convert(reader.result,(pct,msg)=>{
          $('#progressFill').style.width=pct+'%';
          $('#progressLabel').textContent=msg;
        });
        renderResults();
      }catch(err){
        alert('Error parsing GEDCOM: '+err.message);
        console.error(err);
        $('#progressWrap').style.display='none';
      }
    },50);
  };
  reader.readAsText(file);
}

function renderResults(){
  const d=currentData;
  $('#results').style.display='block';
  $('#dropzone').style.display='none';

  // Stats
  const birthEvents=d.events.filter(e=>e.type==='birth').length;
  const deathEvents=d.events.filter(e=>e.type==='death').length;
  $('#statsGrid').innerHTML=[
    {n:d.individuals.length,l:'Individuals'},
    {n:d.events.length,l:'Events'},
    {n:d.sources.length,l:'Sources'},
    {n:birthEvents,l:'Births'},
    {n:deathEvents,l:'Deaths'},
    {n:d.warnings.length,l:'Warnings'}
  ].map(s=>`<div class="stat-card"><div class="num">${s.n}</div><div class="label">${s.l}</div></div>`).join('');

  // Warnings
  if(d.warnings.length){
    $('#warnings').style.display='block';
    $('#warningList').innerHTML=d.warnings.slice(0,100).map(w=>`<li>${esc(w)}</li>`).join('');
  }else{$('#warnings').style.display='none'}

  // Individuals table
  const indiIdMap={};
  d.individuals.forEach(i=>indiIdMap[i.individual_id]=i);
  function nameStr(n){return[(n.given||''),(n.middle||''),(n.surname||'')].filter(Boolean).join(' ')||(n.aliases[0]||'Unknown')}
  function findEventDate(iid,type){const ev=d.events.find(e=>e.type===type&&e.participants.some(p=>p.individual_id===iid));return ev?(ev.date.original||ev.date.normalized):''}

  let rows=d.individuals.map(i=>{
    const bd=findEventDate(i.individual_id,'birth');
    const dd=findEventDate(i.individual_id,'death');
    return`<tr><td>${esc(i.individual_id)}</td><td><strong>${esc(nameStr(i.name))}</strong></td><td><span class="sex-badge sex-${i.sex}">${i.sex}</span></td><td>${esc(bd)}</td><td>${esc(dd)}</td><td>${i.relationships.length}</td><td>${i.living?'<span style="color:var(--green)">Yes</span>':'No'}</td></tr>`;
  }).join('');
  $('#panel-individuals').innerHTML=`<table><thead><tr><th>ID</th><th>Name</th><th>Sex</th><th>Birth</th><th>Death</th><th>Rels</th><th>Living</th></tr></thead><tbody>${rows}</tbody></table>`;

  // Events table
  rows=d.events.slice(0,500).map(e=>{
    const pNames=e.participants.map(p=>{const i=indiIdMap[p.individual_id];return i?nameStr(i.name):p.individual_id}).join(', ');
    return`<tr><td>${esc(e.event_id)}</td><td><span class="type-badge">${e.type}</span></td><td>${esc(e.date.original||e.date.normalized)}</td><td>${esc(e.place.original)}</td><td>${esc(pNames)}</td><td>${e.source_ids.length}</td></tr>`;
  }).join('');
  const evNote=d.events.length>500?`<p style="color:var(--text-muted);margin-top:.5rem;font-size:.8rem">Showing first 500 of ${d.events.length} events</p>`:'';
  $('#panel-events').innerHTML=`<table><thead><tr><th>ID</th><th>Type</th><th>Date</th><th>Place</th><th>Participants</th><th>Sources</th></tr></thead><tbody>${rows}</tbody></table>${evNote}`;

  // Sources table
  rows=d.sources.map(s=>`<tr><td>${esc(s.source_id)}</td><td><span class="type-badge">${s.type}</span></td><td>${esc(s.title)}</td><td>${esc(s.citation).substring(0,80)}</td><td>${esc(s.repository)}</td></tr>`).join('');
  $('#panel-sources').innerHTML=`<table><thead><tr><th>ID</th><th>Type</th><th>Title</th><th>Citation</th><th>Repository</th></tr></thead><tbody>${rows}</tbody></table>`;

  // JSON preview
  const output=buildOutput();
  $('#jsonPreview').textContent=JSON.stringify(output,null,2);
}

function buildOutput(){
  return{lineage_version:'1.0',exported:new Date().toISOString(),individuals:currentData.individuals,events:currentData.events,sources:currentData.sources};
}

// Tabs
document.addEventListener('click',e=>{
  if(!e.target.classList.contains('tab-btn'))return;
  $$('.tab-btn').forEach(b=>b.classList.remove('active'));
  $$('.tab-panel').forEach(p=>p.classList.remove('active'));
  e.target.classList.add('active');
  $(`#panel-${e.target.dataset.tab}`).classList.add('active');
});

// Download
$('#downloadBtn').addEventListener('click',()=>{
  const json=JSON.stringify(buildOutput(),null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='lineage-export.json';a.click();URL.revokeObjectURL(a.href);
});

// Copy
$('#copyBtn').addEventListener('click',()=>{
  navigator.clipboard.writeText(JSON.stringify(buildOutput(),null,2)).then(()=>{$('#copyBtn').textContent='‚úì Copied!';setTimeout(()=>{$('#copyBtn').textContent='üìã Copy to Clipboard'},2000)});
});

// Reset
$('#resetBtn').addEventListener('click',()=>{
  currentData=null;
  $('#results').style.display='none';
  $('#dropzone').style.display='';
  $('#progressWrap').style.display='none';
  $('#progressFill').style.width='0';
  $('#pushProgress').style.display='none';
  fi.value='';
});

// Push to Supabase
$('#pushBtn').addEventListener('click', async ()=>{
  if(!currentData){alert('No data to push');return}
  const db = initSupabase();
  if(!db){alert('Supabase client not available. Check config.');return}

  const prog=$('#pushProgress'); prog.style.display='block';
  const fill=$('#pushFill'); const label=$('#pushLabel'); const log=$('#pushLog');
  log.innerHTML='';
  let success=0,fail=0;

  const d=currentData;
  const total = d.sources.length + d.individuals.length + d.events.length;
  let done=0;

  function update(msg,ok){
    done++;
    fill.style.width=Math.round(done/total*100)+'%';
    label.textContent=`${done} of ${total} records‚Ä¶`;
    const color=ok?'var(--green)':'var(--danger)';
    log.innerHTML+=`<div style="color:${color}">${ok?'‚úì':'‚úó'} ${esc(msg)}</div>`;
    log.scrollTop=log.scrollHeight;
    if(ok)success++;else fail++;
  }

  // Push sources
  label.textContent='Pushing sources‚Ä¶';
  for(const s of d.sources){
    try{
      const row={
        id: s.source_id,
        type: s.type||'other',
        title: s.title||'',
        citation: s.citation||null,
        repository: s.repository||null,
        repository_ref: s.repository_ref||null,
        processing_status: 'imported'
      };
      const {error}=await db.from('sources').upsert(row,{onConflict:'id'});
      if(error)throw error;
      update(`Source: ${s.title||s.source_id}`,true);
    }catch(e){
      update(`Source ${s.source_id}: ${e.message}`,false);
    }
  }

  // Push individuals
  label.textContent='Pushing individuals‚Ä¶';
  for(const i of d.individuals){
    try{
      const row={
        id: i.individual_id,
        given_name: i.name.given||null,
        middle_name: i.name.middle||null,
        surname: i.name.surname||null,
        suffix: i.name.suffix||null,
        maiden_name: i.name.maiden||null,
        aliases: i.name.aliases||[],
        sex: i.sex||'U',
        living: !!i.living,
        research_status: i.research_status||'not_started',
        gedcom_indi_id: i.individual_id
      };
      const {error}=await db.from('individuals').upsert(row,{onConflict:'id'});
      if(error)throw error;
      update(`Individual: ${[i.name.given,i.name.surname].filter(Boolean).join(' ')||i.individual_id}`,true);
    }catch(e){
      update(`Individual ${i.individual_id}: ${e.message}`,false);
    }
  }

  // Push events
  label.textContent='Pushing events‚Ä¶';
  for(const e of d.events){
    try{
      const dateNorm=e.date||{};
      const yearMatch=(dateNorm.normalized||'').match(/^(\d{4})/);
      const row={
        id: e.event_id,
        type: e.type||'other',
        date_original: dateNorm.original||null,
        date_normalized: (dateNorm.normalized&&/^\d{4}-\d{2}(-\d{2})?$/.test(dateNorm.normalized))?dateNorm.normalized:null,
        date_year: yearMatch?parseInt(yearMatch[1]):null,
        date_month: (dateNorm.normalized&&dateNorm.normalized.length>=7)?parseInt(dateNorm.normalized.slice(5,7)):null,
        date_day: (dateNorm.normalized&&dateNorm.normalized.length>=10)?parseInt(dateNorm.normalized.slice(8,10)):null,
        date_precision: dateNorm.precision||null,
        date_qualifier: (dateNorm.qualifier||'').replace(/^ABT$/i,'about').replace(/^BEF$/i,'before').replace(/^AFT$/i,'after')||null,
        place_original: e.place?.original||null,
        place_country: e.place?.country||null,
        place_state: e.place?.state||null,
        place_county: e.place?.county||null,
        place_city: e.place?.city||null,
        confidence: 'possible'
      };
      const {error}=await db.from('events').upsert(row,{onConflict:'id'});
      if(error)throw error;
      update(`Event: ${e.type} (${e.event_id})`,true);
    }catch(e2){
      update(`Event ${e.event_id}: ${e2.message}`,false);
    }
  }

  // Push relationships from individuals
  label.textContent='Pushing relationships‚Ä¶';
  for(const i of d.individuals){
    for(const r of (i.relationships||[])){
      try{
        // Map 'parent' type to father/mother based on the related individual's sex
        let relType = r.type;
        if(relType==='parent'){
          const related = d.individuals.find(x=>x.individual_id===r.individual_id);
          relType = related && related.sex==='F' ? 'mother' : 'father';
        }
        const row={
          individual_id: i.individual_id,
          related_to_id: r.individual_id,
          type: relType,
          confidence: 'possible'
        };
        const {error}=await db.from('relationships').upsert(row,{onConflict:'id',ignoreDuplicates:true});
        // Relationships have serial id, so use insert instead
        if(error){
          const {error:ie}=await db.from('relationships').insert(row);
          if(ie&&!ie.message.includes('duplicate'))throw ie;
        }
      }catch(e){
        // Silent skip for relationship dupes
      }
    }
  }

  fill.style.width='100%';
  label.textContent=`Done! ${success} succeeded, ${fail} failed out of ${total} records.`;
  setConnectionStatus(statusEl, 'connected');
});

})();
</script>
</body>
</html>
